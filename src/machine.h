#pragma once

#ifndef OPCODE_H
#define OPCODE_H

#include <stdint.h>
#include "error.h"
#include "ffi.h"

typedef union machine_register machine_reg_t;

typedef enum gc_trace_mode {
	GC_TRACE_MODE_NONE,
	GC_TRACE_MODE_ALL,
	GC_TRACE_MODE_SOME
} gc_trace_mode_t;

typedef enum machine_op_code {
	MACHINE_OP_CODE_ABORT,
	MACHINE_OP_CODE_FOREIGN_LLL,
	MACHINE_OP_CODE_FOREIGN_LLG,
	MACHINE_OP_CODE_FOREIGN_LGL,
	MACHINE_OP_CODE_FOREIGN_LGG,
	MACHINE_OP_CODE_FOREIGN_GLL,
	MACHINE_OP_CODE_FOREIGN_GLG,
	MACHINE_OP_CODE_FOREIGN_GGL,
	MACHINE_OP_CODE_FOREIGN_GGG,
	MACHINE_OP_CODE_MOVE_LL,
	MACHINE_OP_CODE_MOVE_LG,
	MACHINE_OP_CODE_MOVE_GL,
	MACHINE_OP_CODE_MOVE_GG,
	MACHINE_OP_CODE_SET_L,
	MACHINE_OP_CODE_JUMP,
	MACHINE_OP_CODE_JUMP_CHECK_L,
	MACHINE_OP_CODE_JUMP_CHECK_G,
	MACHINE_OP_CODE_CALL_L,
	MACHINE_OP_CODE_CALL_G,
	MACHINE_OP_CODE_RETURN,
	MACHINE_OP_CODE_LABEL_L,
	MACHINE_OP_CODE_LABEL_G,
	MACHINE_OP_CODE_LOAD_ALLOC_LLL,
	MACHINE_OP_CODE_LOAD_ALLOC_LLG,
	MACHINE_OP_CODE_LOAD_ALLOC_LGL,
	MACHINE_OP_CODE_LOAD_ALLOC_LGG,
	MACHINE_OP_CODE_LOAD_ALLOC_GLL,
	MACHINE_OP_CODE_LOAD_ALLOC_GLG,
	MACHINE_OP_CODE_LOAD_ALLOC_GGL,
	MACHINE_OP_CODE_LOAD_ALLOC_GGG,
	MACHINE_OP_CODE_LOAD_ALLOC_I_LL,
	MACHINE_OP_CODE_LOAD_ALLOC_I_LG,
	MACHINE_OP_CODE_LOAD_ALLOC_I_GL,
	MACHINE_OP_CODE_LOAD_ALLOC_I_GG,
	MACHINE_OP_CODE_LOAD_ALLOC_I_BOUND_LL,
	MACHINE_OP_CODE_LOAD_ALLOC_I_BOUND_LG,
	MACHINE_OP_CODE_LOAD_ALLOC_I_BOUND_GL,
	MACHINE_OP_CODE_LOAD_ALLOC_I_BOUND_GG,
	MACHINE_OP_CODE_STORE_ALLOC_LLL,
	MACHINE_OP_CODE_STORE_ALLOC_LLG,
	MACHINE_OP_CODE_STORE_ALLOC_LGL,
	MACHINE_OP_CODE_STORE_ALLOC_LGG,
	MACHINE_OP_CODE_STORE_ALLOC_GLL,
	MACHINE_OP_CODE_STORE_ALLOC_GLG,
	MACHINE_OP_CODE_STORE_ALLOC_GGL,
	MACHINE_OP_CODE_STORE_ALLOC_GGG,
	MACHINE_OP_CODE_STORE_ALLOC_I_LL,
	MACHINE_OP_CODE_STORE_ALLOC_I_LG,
	MACHINE_OP_CODE_STORE_ALLOC_I_GL,
	MACHINE_OP_CODE_STORE_ALLOC_I_GG,
	MACHINE_OP_CODE_STORE_ALLOC_I_BOUND_LL,
	MACHINE_OP_CODE_STORE_ALLOC_I_BOUND_LG,
	MACHINE_OP_CODE_STORE_ALLOC_I_BOUND_GL,
	MACHINE_OP_CODE_STORE_ALLOC_I_BOUND_GG,
	MACHINE_OP_CODE_CONF_TRACE_L,
	MACHINE_OP_CODE_CONF_TRACE_G,
	MACHINE_OP_CODE_DYNAMIC_CONF_LL,
	MACHINE_OP_CODE_DYNAMIC_CONF_ALL_LL,
	MACHINE_OP_CODE_STACK_OFFSET,
	MACHINE_OP_CODE_STACK_DEOFFSET,
	MACHINE_OP_CODE_ALLOC_LL,
	MACHINE_OP_CODE_ALLOC_LG,
	MACHINE_OP_CODE_ALLOC_GL,
	MACHINE_OP_CODE_ALLOC_GG,
	MACHINE_OP_CODE_ALLOC_I_L,
	MACHINE_OP_CODE_ALLOC_I_G,
	MACHINE_OP_CODE_FREE_L,
	MACHINE_OP_CODE_FREE_G,
	MACHINE_OP_CODE_DYNAMIC_FREE_LL,
	MACHINE_OP_CODE_GC_NEW_FRAME,
	MACHINE_OP_CODE_GC_TRACE_L,
	MACHINE_OP_CODE_GC_TRACE_G,
	MACHINE_OP_CODE_DYNAMIC_TRACE_LL,
	MACHINE_OP_CODE_GC_CLEAN,
	MACHINE_OP_CODE_AND_LLL,
	MACHINE_OP_CODE_AND_LLG,
	MACHINE_OP_CODE_AND_LGL,
	MACHINE_OP_CODE_AND_LGG,
	MACHINE_OP_CODE_AND_GLL,
	MACHINE_OP_CODE_AND_GLG,
	MACHINE_OP_CODE_AND_GGL,
	MACHINE_OP_CODE_AND_GGG,
	MACHINE_OP_CODE_OR_LLL,
	MACHINE_OP_CODE_OR_LLG,
	MACHINE_OP_CODE_OR_LGL,
	MACHINE_OP_CODE_OR_LGG,
	MACHINE_OP_CODE_OR_GLL,
	MACHINE_OP_CODE_OR_GLG,
	MACHINE_OP_CODE_OR_GGL,
	MACHINE_OP_CODE_OR_GGG,
	MACHINE_OP_CODE_NOT_LL,
	MACHINE_OP_CODE_NOT_LG,
	MACHINE_OP_CODE_NOT_GL,
	MACHINE_OP_CODE_NOT_GG,
	MACHINE_OP_CODE_LENGTH_LL,
	MACHINE_OP_CODE_LENGTH_LG,
	MACHINE_OP_CODE_LENGTH_GL,
	MACHINE_OP_CODE_LENGTH_GG,

	MACHINE_OP_CODE_BOOL_EQUAL_LLL,
	MACHINE_OP_CODE_BOOL_EQUAL_LLG,
	MACHINE_OP_CODE_BOOL_EQUAL_LGL,
	MACHINE_OP_CODE_BOOL_EQUAL_LGG,
	MACHINE_OP_CODE_BOOL_EQUAL_GLL,
	MACHINE_OP_CODE_BOOL_EQUAL_GLG,
	MACHINE_OP_CODE_BOOL_EQUAL_GGL,
	MACHINE_OP_CODE_BOOL_EQUAL_GGG,
	MACHINE_OP_CODE_CHAR_EQUAL_LLL,
	MACHINE_OP_CODE_CHAR_EQUAL_LLG,
	MACHINE_OP_CODE_CHAR_EQUAL_LGL,
	MACHINE_OP_CODE_CHAR_EQUAL_LGG,
	MACHINE_OP_CODE_CHAR_EQUAL_GLL,
	MACHINE_OP_CODE_CHAR_EQUAL_GLG,
	MACHINE_OP_CODE_CHAR_EQUAL_GGL,
	MACHINE_OP_CODE_CHAR_EQUAL_GGG,
	MACHINE_OP_CODE_LONG_EQUAL_LLL,
	MACHINE_OP_CODE_LONG_EQUAL_LLG,
	MACHINE_OP_CODE_LONG_EQUAL_LGL,
	MACHINE_OP_CODE_LONG_EQUAL_LGG,
	MACHINE_OP_CODE_LONG_EQUAL_GLL,
	MACHINE_OP_CODE_LONG_EQUAL_GLG,
	MACHINE_OP_CODE_LONG_EQUAL_GGL,
	MACHINE_OP_CODE_LONG_EQUAL_GGG,
	MACHINE_OP_CODE_FLOAT_EQUAL_LLL,
	MACHINE_OP_CODE_FLOAT_EQUAL_LLG,
	MACHINE_OP_CODE_FLOAT_EQUAL_LGL,
	MACHINE_OP_CODE_FLOAT_EQUAL_LGG,
	MACHINE_OP_CODE_FLOAT_EQUAL_GLL,
	MACHINE_OP_CODE_FLOAT_EQUAL_GLG,
	MACHINE_OP_CODE_FLOAT_EQUAL_GGL,
	MACHINE_OP_CODE_FLOAT_EQUAL_GGG,

	MACHINE_OP_CODE_LONG_MORE_LLL,
	MACHINE_OP_CODE_LONG_MORE_LLG,
	MACHINE_OP_CODE_LONG_MORE_LGL,
	MACHINE_OP_CODE_LONG_MORE_LGG,
	MACHINE_OP_CODE_LONG_MORE_GLL,
	MACHINE_OP_CODE_LONG_MORE_GLG,
	MACHINE_OP_CODE_LONG_MORE_GGL,
	MACHINE_OP_CODE_LONG_MORE_GGG,
	MACHINE_OP_CODE_LONG_LESS_LLL,
	MACHINE_OP_CODE_LONG_LESS_LLG,
	MACHINE_OP_CODE_LONG_LESS_LGL,
	MACHINE_OP_CODE_LONG_LESS_LGG,
	MACHINE_OP_CODE_LONG_LESS_GLL,
	MACHINE_OP_CODE_LONG_LESS_GLG,
	MACHINE_OP_CODE_LONG_LESS_GGL,
	MACHINE_OP_CODE_LONG_LESS_GGG,
	MACHINE_OP_CODE_LONG_MORE_EQUAL_LLL,
	MACHINE_OP_CODE_LONG_MORE_EQUAL_LLG,
	MACHINE_OP_CODE_LONG_MORE_EQUAL_LGL,
	MACHINE_OP_CODE_LONG_MORE_EQUAL_LGG,
	MACHINE_OP_CODE_LONG_MORE_EQUAL_GLL,
	MACHINE_OP_CODE_LONG_MORE_EQUAL_GLG,
	MACHINE_OP_CODE_LONG_MORE_EQUAL_GGL,
	MACHINE_OP_CODE_LONG_MORE_EQUAL_GGG,
	MACHINE_OP_CODE_LONG_LESS_EQUAL_LLL,
	MACHINE_OP_CODE_LONG_LESS_EQUAL_LLG,
	MACHINE_OP_CODE_LONG_LESS_EQUAL_LGL,
	MACHINE_OP_CODE_LONG_LESS_EQUAL_LGG,
	MACHINE_OP_CODE_LONG_LESS_EQUAL_GLL,
	MACHINE_OP_CODE_LONG_LESS_EQUAL_GLG,
	MACHINE_OP_CODE_LONG_LESS_EQUAL_GGL,
	MACHINE_OP_CODE_LONG_LESS_EQUAL_GGG,
	MACHINE_OP_CODE_LONG_ADD_LLL,
	MACHINE_OP_CODE_LONG_ADD_LLG,
	MACHINE_OP_CODE_LONG_ADD_LGL,
	MACHINE_OP_CODE_LONG_ADD_LGG,
	MACHINE_OP_CODE_LONG_ADD_GLL,
	MACHINE_OP_CODE_LONG_ADD_GLG,
	MACHINE_OP_CODE_LONG_ADD_GGL,
	MACHINE_OP_CODE_LONG_ADD_GGG,
	MACHINE_OP_CODE_LONG_SUBTRACT_LLL,
	MACHINE_OP_CODE_LONG_SUBTRACT_LLG,
	MACHINE_OP_CODE_LONG_SUBTRACT_LGL,
	MACHINE_OP_CODE_LONG_SUBTRACT_LGG,
	MACHINE_OP_CODE_LONG_SUBTRACT_GLL,
	MACHINE_OP_CODE_LONG_SUBTRACT_GLG,
	MACHINE_OP_CODE_LONG_SUBTRACT_GGL,
	MACHINE_OP_CODE_LONG_SUBTRACT_GGG,
	MACHINE_OP_CODE_LONG_MULTIPLY_LLL,
	MACHINE_OP_CODE_LONG_MULTIPLY_LLG,
	MACHINE_OP_CODE_LONG_MULTIPLY_LGL,
	MACHINE_OP_CODE_LONG_MULTIPLY_LGG,
	MACHINE_OP_CODE_LONG_MULTIPLY_GLL,
	MACHINE_OP_CODE_LONG_MULTIPLY_GLG,
	MACHINE_OP_CODE_LONG_MULTIPLY_GGL,
	MACHINE_OP_CODE_LONG_MULTIPLY_GGG,
	MACHINE_OP_CODE_LONG_DIVIDE_LLL,
	MACHINE_OP_CODE_LONG_DIVIDE_LLG,
	MACHINE_OP_CODE_LONG_DIVIDE_LGL,
	MACHINE_OP_CODE_LONG_DIVIDE_LGG,
	MACHINE_OP_CODE_LONG_DIVIDE_GLL,
	MACHINE_OP_CODE_LONG_DIVIDE_GLG,
	MACHINE_OP_CODE_LONG_DIVIDE_GGL,
	MACHINE_OP_CODE_LONG_DIVIDE_GGG,
	MACHINE_OP_CODE_LONG_MODULO_LLL,
	MACHINE_OP_CODE_LONG_MODULO_LLG,
	MACHINE_OP_CODE_LONG_MODULO_LGL,
	MACHINE_OP_CODE_LONG_MODULO_LGG,
	MACHINE_OP_CODE_LONG_MODULO_GLL,
	MACHINE_OP_CODE_LONG_MODULO_GLG,
	MACHINE_OP_CODE_LONG_MODULO_GGL,
	MACHINE_OP_CODE_LONG_MODULO_GGG,
	MACHINE_OP_CODE_LONG_EXPONENTIATE_LLL,
	MACHINE_OP_CODE_LONG_EXPONENTIATE_LLG,
	MACHINE_OP_CODE_LONG_EXPONENTIATE_LGL,
	MACHINE_OP_CODE_LONG_EXPONENTIATE_LGG,
	MACHINE_OP_CODE_LONG_EXPONENTIATE_GLL,
	MACHINE_OP_CODE_LONG_EXPONENTIATE_GLG,
	MACHINE_OP_CODE_LONG_EXPONENTIATE_GGL,
	MACHINE_OP_CODE_LONG_EXPONENTIATE_GGG,

	MACHINE_OP_CODE_FLOAT_MORE_LLL,
	MACHINE_OP_CODE_FLOAT_MORE_LLG,
	MACHINE_OP_CODE_FLOAT_MORE_LGL,
	MACHINE_OP_CODE_FLOAT_MORE_LGG,
	MACHINE_OP_CODE_FLOAT_MORE_GLL,
	MACHINE_OP_CODE_FLOAT_MORE_GLG,
	MACHINE_OP_CODE_FLOAT_MORE_GGL,
	MACHINE_OP_CODE_FLOAT_MORE_GGG,
	MACHINE_OP_CODE_FLOAT_LESS_LLL,
	MACHINE_OP_CODE_FLOAT_LESS_LLG,
	MACHINE_OP_CODE_FLOAT_LESS_LGL,
	MACHINE_OP_CODE_FLOAT_LESS_LGG,
	MACHINE_OP_CODE_FLOAT_LESS_GLL,
	MACHINE_OP_CODE_FLOAT_LESS_GLG,
	MACHINE_OP_CODE_FLOAT_LESS_GGL,
	MACHINE_OP_CODE_FLOAT_LESS_GGG,
	MACHINE_OP_CODE_FLOAT_MORE_EQUAL_LLL,
	MACHINE_OP_CODE_FLOAT_MORE_EQUAL_LLG,
	MACHINE_OP_CODE_FLOAT_MORE_EQUAL_LGL,
	MACHINE_OP_CODE_FLOAT_MORE_EQUAL_LGG,
	MACHINE_OP_CODE_FLOAT_MORE_EQUAL_GLL,
	MACHINE_OP_CODE_FLOAT_MORE_EQUAL_GLG,
	MACHINE_OP_CODE_FLOAT_MORE_EQUAL_GGL,
	MACHINE_OP_CODE_FLOAT_MORE_EQUAL_GGG,
	MACHINE_OP_CODE_FLOAT_LESS_EQUAL_LLL,
	MACHINE_OP_CODE_FLOAT_LESS_EQUAL_LLG,
	MACHINE_OP_CODE_FLOAT_LESS_EQUAL_LGL,
	MACHINE_OP_CODE_FLOAT_LESS_EQUAL_LGG,
	MACHINE_OP_CODE_FLOAT_LESS_EQUAL_GLL,
	MACHINE_OP_CODE_FLOAT_LESS_EQUAL_GLG,
	MACHINE_OP_CODE_FLOAT_LESS_EQUAL_GGL,
	MACHINE_OP_CODE_FLOAT_LESS_EQUAL_GGG,
	MACHINE_OP_CODE_FLOAT_ADD_LLL,
	MACHINE_OP_CODE_FLOAT_ADD_LLG,
	MACHINE_OP_CODE_FLOAT_ADD_LGL,
	MACHINE_OP_CODE_FLOAT_ADD_LGG,
	MACHINE_OP_CODE_FLOAT_ADD_GLL,
	MACHINE_OP_CODE_FLOAT_ADD_GLG,
	MACHINE_OP_CODE_FLOAT_ADD_GGL,
	MACHINE_OP_CODE_FLOAT_ADD_GGG,
	MACHINE_OP_CODE_FLOAT_SUBTRACT_LLL,
	MACHINE_OP_CODE_FLOAT_SUBTRACT_LLG,
	MACHINE_OP_CODE_FLOAT_SUBTRACT_LGL,
	MACHINE_OP_CODE_FLOAT_SUBTRACT_LGG,
	MACHINE_OP_CODE_FLOAT_SUBTRACT_GLL,
	MACHINE_OP_CODE_FLOAT_SUBTRACT_GLG,
	MACHINE_OP_CODE_FLOAT_SUBTRACT_GGL,
	MACHINE_OP_CODE_FLOAT_SUBTRACT_GGG,
	MACHINE_OP_CODE_FLOAT_MULTIPLY_LLL,
	MACHINE_OP_CODE_FLOAT_MULTIPLY_LLG,
	MACHINE_OP_CODE_FLOAT_MULTIPLY_LGL,
	MACHINE_OP_CODE_FLOAT_MULTIPLY_LGG,
	MACHINE_OP_CODE_FLOAT_MULTIPLY_GLL,
	MACHINE_OP_CODE_FLOAT_MULTIPLY_GLG,
	MACHINE_OP_CODE_FLOAT_MULTIPLY_GGL,
	MACHINE_OP_CODE_FLOAT_MULTIPLY_GGG,
	MACHINE_OP_CODE_FLOAT_DIVIDE_LLL,
	MACHINE_OP_CODE_FLOAT_DIVIDE_LLG,
	MACHINE_OP_CODE_FLOAT_DIVIDE_LGL,
	MACHINE_OP_CODE_FLOAT_DIVIDE_LGG,
	MACHINE_OP_CODE_FLOAT_DIVIDE_GLL,
	MACHINE_OP_CODE_FLOAT_DIVIDE_GLG,
	MACHINE_OP_CODE_FLOAT_DIVIDE_GGL,
	MACHINE_OP_CODE_FLOAT_DIVIDE_GGG,
	MACHINE_OP_CODE_FLOAT_MODULO_LLL,
	MACHINE_OP_CODE_FLOAT_MODULO_LLG,
	MACHINE_OP_CODE_FLOAT_MODULO_LGL,
	MACHINE_OP_CODE_FLOAT_MODULO_LGG,
	MACHINE_OP_CODE_FLOAT_MODULO_GLL,
	MACHINE_OP_CODE_FLOAT_MODULO_GLG,
	MACHINE_OP_CODE_FLOAT_MODULO_GGL,
	MACHINE_OP_CODE_FLOAT_MODULO_GGG,
	MACHINE_OP_CODE_FLOAT_EXPONENTIATE_LLL,
	MACHINE_OP_CODE_FLOAT_EXPONENTIATE_LLG,
	MACHINE_OP_CODE_FLOAT_EXPONENTIATE_LGL,
	MACHINE_OP_CODE_FLOAT_EXPONENTIATE_LGG,
	MACHINE_OP_CODE_FLOAT_EXPONENTIATE_GLL,
	MACHINE_OP_CODE_FLOAT_EXPONENTIATE_GLG,
	MACHINE_OP_CODE_FLOAT_EXPONENTIATE_GGL,
	MACHINE_OP_CODE_FLOAT_EXPONENTIATE_GGG,

	MACHINE_OP_CODE_LONG_NEGATE_LL,
	MACHINE_OP_CODE_LONG_NEGATE_LG,
	MACHINE_OP_CODE_LONG_NEGATE_GL,
	MACHINE_OP_CODE_LONG_NEGATE_GG,

	MACHINE_OP_CODE_FLOAT_NEGATE_LL,
	MACHINE_OP_CODE_FLOAT_NEGATE_LG,
	MACHINE_OP_CODE_FLOAT_NEGATE_GL,
	MACHINE_OP_CODE_FLOAT_NEGATE_GG,
} machine_op_code_t;

typedef struct machine_instruction {
	machine_op_code_t op_code;
	uint16_t a, b, c;
} machine_ins_t;

typedef struct machine_heap_alloc {
	machine_reg_t* registers;
	int* init_stat, *trace_stat;
	uint16_t limit;

	int gc_flag, reg_with_table, pre_freed;
	gc_trace_mode_t trace_mode;
} heap_alloc_t;

typedef union machine_register {
	heap_alloc_t* heap_alloc;
	int64_t long_int;
	double float_int;
	char char_int;
	int bool_flag;
	machine_ins_t* ip;
} machine_reg_t;

typedef struct machine {
	machine_reg_t* stack;

	machine_ins_t** positions;

	heap_alloc_t** heap_allocs;
	uint16_t* heap_frame_bounds;

	heap_alloc_t** heap_traces;
	uint16_t* trace_frame_bounds;

	heap_alloc_t** freed_heap_allocs;

	error_t last_err;
	
	uint16_t global_offset, position_count, heap_frame, frame_limit, heap_count, heap_alloc_limit, trace_count, trace_alloc_limit, freed_heap_count, alloc_freed_heaps;

	ffi_t ffi_table;
} machine_t;

int init_machine(machine_t* machine, uint16_t stack_size, uint16_t heap_alloc_limit, uint16_t frame_limit);
void free_machine(machine_t* machine);

int machine_execute(machine_t* machine, machine_ins_t* instructions);

heap_alloc_t* machine_alloc(machine_t* machine, uint16_t req_size, gc_trace_mode_t trace_mode);
#endif // !OPCODE_H